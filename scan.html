<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>FreshChain – Product Traceability Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f6f6f6;
  margin: 0;
  padding: 20px;
}

.container {
  max-width: 850px;
  margin: auto;
  background: #ffffff;
  padding: 24px;
  border-radius: 14px;
}

.section {
  margin-bottom: 22px;
}

.section h3 {
  margin-bottom: 8px;
}

.box {
  background: #f2f2f2;
  padding: 14px;
  border-radius: 10px;
  white-space: pre-wrap;
  font-size: 14px;
}

.status-line {
  font-size: 15px;
  font-weight: bold;
  margin: 4px 0;
}

button {
  width: 100%;
  padding: 14px;
  font-size: 16px;
  border: none;
  border-radius: 10px;
  background: #222;
  color: #fff;
  cursor: pointer;
}

@media print {
  button { display: none; }
}
</style>
</head>

<body>

<div class="container">
  <h2>FreshChain – Product Traceability Report</h2>

  <div class="section">
    <h3> Product Info</h3>
    <div class="box" id="productInfo"></div>
  </div>

  <div class="section">
    <h3> Participants</h3>
    <div class="box" id="participants"></div>
  </div>

  <div class="section">
    <h3> Status</h3>
    <div id="status"></div>
  </div>

  <div class="section">
    <h3> Sensor Data</h3>
    <div class="box" id="sensorData"></div>
  </div>

  <div class="section">
    <h3> Ownership History</h3>
    <div class="box" id="ownership"></div>
  </div>

  <button onclick="window.print()"> Print / Download PDF</button>
</div>

<script>
const CONTRACT_ADDRESS = "0xC7d8B75156Ac7fd509aD5eC360Bd0258A4459bfd";
const RPC = "https://eth-sepolia.g.alchemy.com/v2/7nq9DSo1P4TvLc7p9bOfr";

const ABI = [
  "function getBatchHistory(uint256) view returns (uint256,string,uint256,address,address,address,address,bool,bool,(int256,int256,string,uint256,address)[],(address,address,uint256)[])"
];

const batchId = new URLSearchParams(window.location.search).get("batchId");

async function loadHistory() {
  const provider = new ethers.providers.JsonRpcProvider(RPC);
  const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
  const b = await contract.getBatchHistory(batchId);

  productInfo.innerText =
`Batch ID: ${b[0]}
Product: ${b[1]}
Quantity: ${b[2]}`;

  participants.innerText =
`Producer: ${b[3]}
Distributor: ${b[4]}
Retailer: ${b[5]}
Current Owner: ${b[6]}`;

  /* ===== STATUS (ABSOLUTE FIX) ===== */
  const arrived = Boolean(b[7]);
  const inspected = Boolean(b[8]);

  status.innerHTML = `
    <div class="status-line">Arrived: ${arrived ? "YES" : "NO"}</div>
    <div class="status-line">Inspection Passed: ${inspected ? "YES" : "NO"}</div>
  `;

  sensorData.innerText = b[9].length === 0
    ? "No sensor data recorded."
    : b[9].map((s,i)=>`Record ${i+1}
Temperature: ${s[0]} °C
Humidity: ${s[1]} %
Location: ${s[2]}
Time: ${new Date(Number(s[3])*1000).toLocaleString()}
Transporter: ${s[4]}`).join("\n\n");

  ownership.innerText = b[10].map((o,i)=>`Step ${i+1}
From: ${o[0]}
To: ${o[1]}
Time: ${new Date(Number(o[2])*1000).toLocaleString()}`).join("\n\n");
}

loadHistory();
</script>

</body>
</html>
