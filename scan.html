<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>FreshChain – Product History</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f7f7f7;
  margin: 0;
  padding: 20px;
}

.container {
  max-width: 800px;
  margin: auto;
  background: #fff;
  padding: 20px;
  border-radius: 14px;
}

/* Sections */
.section {
  margin-bottom: 20px;
}
.section h3 {
  margin-bottom: 10px;
}

/* History box */
.box {
  background: #f3f3f3;
  padding: 14px;
  border-radius: 10px;
  white-space: pre-wrap;
}

/* Button */
button {
  padding: 14px;
  width: 100%;
  font-size: 16px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  background: #222;
  color: #fff;
}
button:hover {
  background: #444;
}

/* PRINT STYLES */
@media print {
  button {
    display: none;
  }
  body {
    background: white;
  }
  .container {
    box-shadow: none;
    border-radius: 0;
  }
}
</style>
</head>

<body>

<div class="container" id="printArea">
  <h2>FreshChain – Product Traceability Report</h2>

  <div class="section">
    <h3> Product Info</h3>
    <div class="box" id="productInfo">Loading...</div>
  </div>

  <div class="section">
    <h3> Participants</h3>
    <div class="box" id="participants"></div>
  </div>

  <div class="section">
    <h3> Status</h3>
    <div class="box" id="status"></div>
  </div>

  <div class="section">
    <h3> Sensor Data</h3>
    <div class="box" id="sensorData"></div>
  </div>

  <div class="section">
    <h3> Ownership History</h3>
    <div class="box" id="ownership"></div>
  </div>

  <button onclick="window.print()"> Print / Download PDF</button>
</div>

<script>
/* ================= CONFIG ================= */
const CONTRACT_ADDRESS = "0xC7d8B75156Ac7fd509aD5eC360Bd0258A4459bfd";
const RPC = "https://eth-sepolia.g.alchemy.com/v2/7nq9DSo1P4TvLc7p9bOfr";

const ABI = [
 "function getBatchHistory(uint256) view returns(uint256,string,uint256,address,address,address,address,bool,bool,(int256,int256,string,uint256,address)[],(address,address,uint256)[])"
];

/* ================= LOAD DATA ================= */
const params = new URLSearchParams(window.location.search);
const batchId = params.get("batchId");

async function loadHistory() {
  if (!batchId) {
    alert("No batchId provided in URL");
    return;
  }

  const provider = new ethers.providers.JsonRpcProvider(RPC);
  const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

  const data = await contract.getBatchHistory(batchId);

  /* Product Info */
  productInfo.innerText =
    `Batch ID: ${data[0]}
Product: ${data[1]}
Quantity: ${data[2]}`;

  /* Participants */
  participants.innerText =
    `Producer: ${data[3]}
Distributor: ${data[5]}
Retailer: ${data[6]}
Current Owner: ${data[4]}`;

  /* Status */
  status.innerText =
    `Arrived: ${data[7]}
Inspection Passed: ${data[8]}`;

  /* Sensor Data */
  if (data[9].length === 0) {
    sensorData.innerText = "No sensor data recorded.";
  } else {
    sensorData.innerText = data[9].map((s, i) =>
      `Record ${i + 1}
Temperature: ${s.temperature} °C
Humidity: ${s.humidity} %
Location: ${s.location}
Time: ${new Date(s.timestamp * 1000).toLocaleString()}
Transporter: ${s.transporter}`
    ).join("\n\n");
  }

  /* Ownership History */
  if (data[10].length === 0) {
    ownership.innerText = "No ownership transfers.";
  } else {
    ownership.innerText = data[10].map((o, i) =>
      `Step ${i + 1}
From: ${o.from}
To: ${o.to}
Time: ${new Date(o.timestamp * 1000).toLocaleString()}`
    ).join("\n\n");
  }
}

loadHistory();
</script>

</body>
</html>
