<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>FreshChain ‚Äì Product Traceability Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f7f7f7;
  margin: 0;
  padding: 20px;
}

.container {
  max-width: 800px;
  margin: auto;
  background: #fff;
  padding: 20px;
  border-radius: 14px;
}

.section {
  margin-bottom: 20px;
}

.section h3 {
  margin-bottom: 10px;
}

.box {
  background: #f3f3f3;
  padding: 14px;
  border-radius: 10px;
  white-space: pre-wrap;
}

/* Status badges */
.status-ok {
  color: green;
  font-weight: bold;
}
.status-bad {
  color: red;
  font-weight: bold;
}

button {
  padding: 14px;
  width: 100%;
  font-size: 16px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  background: #222;
  color: #fff;
}

button:hover {
  background: #444;
}

@media print {
  button { display: none; }
  body { background: white; }
  .container { box-shadow: none; }
}
</style>
</head>

<body>

<div class="container">
  <h2>FreshChain ‚Äì Product Traceability Report</h2>

  <div class="section">
    <h3>üì¶ Product Info</h3>
    <div class="box" id="productInfo"></div>
  </div>

  <div class="section">
    <h3>üë• Participants</h3>
    <div class="box" id="participants"></div>
  </div>

  <div class="section">
    <h3>‚úÖ Status</h3>
    <div class="box" id="status"></div>
  </div>

  <div class="section">
    <h3>üå°Ô∏è Sensor Data</h3>
    <div class="box" id="sensorData"></div>
  </div>

  <div class="section">
    <h3>üîÅ Ownership History</h3>
    <div class="box" id="ownership"></div>
  </div>

  <button onclick="window.print()">üñ®Ô∏è Print / Download PDF</button>
</div>

<script>
/* ===== CONFIG ===== */
const CONTRACT_ADDRESS = "0xC7d8B75156Ac7fd509aD5eC360Bd0258A4459bfd";
const RPC = "https://eth-sepolia.g.alchemy.com/v2/7nq9DSo1P4TvLc7p9bOfr";

const ABI = [
  "function getBatchHistory(uint256) view returns (uint256,string,uint256,address,address,address,address,bool,bool,(int256,int256,string,uint256,address)[],(address,address,uint256)[])"
];

const params = new URLSearchParams(window.location.search);
const batchId = params.get("batchId");

async function loadHistory() {
  if (!batchId) {
    alert("No batchId provided in URL");
    return;
  }

  const provider = new ethers.providers.JsonRpcProvider(RPC);
  const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
  const b = await contract.getBatchHistory(batchId);

  /* Product */
  productInfo.innerText =
`Batch ID: ${b[0]}
Product: ${b[1]}
Quantity: ${b[2]}`;

  /* Participants */
  participants.innerText =
`Producer: ${b[3]}
Distributor: ${b[4]}
Retailer: ${b[5]}
Current Owner: ${b[6]}`;

  /* STATUS (FIXED) */
  const arrivedText = b[7]
    ? "üü¢ Arrived"
    : "üî¥ Not Arrived";

  const inspectionText = b[8]
    ? "‚úÖ Inspection Passed"
    : "‚ùå Inspection Failed";

  status.innerHTML =
`<span class="${b[7] ? "status-ok" : "status-bad"}">${arrivedText}</span>
<br>
<span class="${b[8] ? "status-ok" : "status-bad"}">${inspectionText}</span>`;

  /* Sensor Data */
  if (b[9].length === 0) {
    sensorData.innerText = "No sensor data recorded.";
  } else {
    sensorData.innerText = b[9].map((s, i) =>
`Record ${i + 1}
Temperature: ${s[0]} ¬∞C
Humidity: ${s[1]} %
Location: ${s[2]}
Time: ${new Date(Number(s[3]) * 1000).toLocaleString()}
Transporter: ${s[4]}`
    ).join("\n\n");
  }

  /* Ownership */
  ownership.innerText = b[10].map((o, i) =>
`Step ${i + 1}
From: ${o[0]}
To: ${o[1]}
Time: ${new Date(Number(o[2]) * 1000).toLocaleString()}`
  ).join("\n\n");
}

loadHistory();
</script>

</body>
</html>
