<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>FreshChain â€“ Product Traceability Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f6f6f6;
  margin: 0;
  padding: 20px;
}

.container {
  max-width: 800px;
  margin: auto;
  background: #ffffff;
  padding: 24px;
  border-radius: 14px;
}

.section {
  margin-bottom: 22px;
}

.section h3 {
  margin-bottom: 8px;
}

.box {
  background: #f2f2f2;
  padding: 14px;
  border-radius: 10px;
  white-space: pre-wrap;
  font-size: 14px;
}

button {
  width: 100%;
  padding: 14px;
  font-size: 16px;
  border: none;
  border-radius: 10px;
  background: #222;
  color: #fff;
  cursor: pointer;
}

button:hover {
  background: #444;
}

@media print {
  button { display: none; }
  body { background: white; }
  .container { box-shadow: none; }
}
</style>
</head>

<body>

<div class="container">
  <h2>FreshChain â€“ Product Traceability Report</h2>

  <div class="section">
    <h3>ğŸ“¦ Product Info</h3>
    <div class="box" id="productInfo">Loading...</div>
  </div>

  <div class="section">
    <h3>ğŸ‘¥ Participants</h3>
    <div class="box" id="participants"></div>
  </div>

  <div class="section">
    <h3>âœ… Status</h3>
    <div class="box" id="status"></div>
  </div>

  <div class="section">
    <h3>ğŸŒ¡ï¸ Sensor Data</h3>
    <div class="box" id="sensorData"></div>
  </div>

  <div class="section">
    <h3>ğŸ” Ownership History</h3>
    <div class="box" id="ownership"></div>
  </div>

  <button onclick="window.print()">ğŸ–¨ï¸ Print / Download PDF</button>
</div>

<script>
/* ================= CONFIG ================= */
const CONTRACT_ADDRESS = "0xC7d8B75156Ac7fd509aD5eC360Bd0258A4459bfd";
const RPC = "https://eth-sepolia.g.alchemy.com/v2/7nq9DSo1P4TvLc7p9bOfr";

const ABI = [
  "function getBatchHistory(uint256) view returns (uint256,string,uint256,address,address,address,address,bool,bool,(int256,int256,string,uint256,address)[],(address,address,uint256)[])"
];

/* ================= LOAD ================= */
const params = new URLSearchParams(window.location.search);
const batchId = params.get("batchId");

async function loadHistory() {
  if (!batchId) {
    alert("âŒ No batchId provided in URL");
    return;
  }

  const provider = new ethers.providers.JsonRpcProvider(RPC);
  const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

  const b = await contract.getBatchHistory(batchId);

  /* ===== PRODUCT INFO ===== */
  productInfo.innerText =
`Batch ID: ${b[0]}
Product: ${b[1]}
Quantity: ${b[2]}`;

  /* ===== PARTICIPANTS ===== */
  participants.innerText =
`Producer: ${b[3]}
Distributor: ${b[4]}
Retailer: ${b[5]}
Current Owner: ${b[6]}`;

  /* ===== STATUS (BULLETPROOF) ===== */
  let statusText = "";
  statusText += "Arrived: " + (b[7] ? "YES" : "NO") + "\n";
  statusText += "Inspection Passed: " + (b[8] ? "YES" : "NO");
  status.innerText = statusText;

  /* ===== SENSOR DATA ===== */
  if (b[9].length === 0) {
    sensorData.innerText = "No sensor data recorded.";
  } else {
    sensorData.innerText = b[9].map((s, i) =>
`Record ${i + 1}
Temperature: ${s[0]} Â°C
Humidity: ${s[1]} %
Location: ${s[2]}
Time: ${new Date(Number(s[3]) * 1000).toLocaleString()}
Transporter: ${s[4]}`
    ).join("\n\n");
  }

  /* ===== OWNERSHIP HISTORY ===== */
  if (b[10].length === 0) {
    ownership.innerText = "No ownership transfers.";
  } else {
    ownership.innerText = b[10].map((o, i) =>
`Step ${i + 1}
From: ${o[0]}
To: ${o[1]}
Time: ${new Date(Number(o[2]) * 1000).toLocaleString()}`
    ).join("\n\n");
  }
}

loadHistory();
</script>

</body>
</html>
