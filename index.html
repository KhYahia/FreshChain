<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FreshChain ‚Äì Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
body { margin:0; font-family:Arial; display:flex; height:100vh; }
.sidebar {
  width:300px; background:#111; color:#fff; padding:20px;
}
.sidebar button {
  width:100%; padding:12px; margin:6px 0;
  border:none; border-radius:8px;
  background:#222; color:#fff; cursor:pointer;
}
.sidebar button:hover { background:#444; }
#account { font-size:13px; word-break:break-all; color:#ccc; }
#role { margin-top:6px; color:#9ae6b4; }

.main { flex:1; padding:20px; overflow:auto; }
.card {
  max-width:520px;
  border:1px solid #ccc;
  padding:16px;
  border-radius:12px;
  margin-bottom:20px;
}
input, button { width:100%; padding:12px; margin-top:8px; }
.hidden { display:none; }

.status { padding:12px; border-radius:8px; margin-bottom:12px; }
.ok { background:#e6fffa; color:#065f46; }
.err { background:#fee2e2; color:#7f1d1d; }
</style>
</head>

<body>

<div class="sidebar">
  <h2>FreshChain</h2>
  <button onclick="connect()">üîå Connect Wallet</button>
  <div id="account">Not connected</div>
  <div id="role">Role: -</div>
  <hr>
  <button onclick="openPanel('admin')">Admin</button>
  <button onclick="openPanel('producer')">Producer</button>
  <button onclick="openPanel('transporter')">Transporter</button>
  <button onclick="openPanel('distributor')">Distributor</button>
  <button onclick="openPanel('retailer')">Retailer</button>
  <button onclick="openPanel('customer')">Customer</button>
</div>

<div class="main">
  <div id="status"></div>

  <!-- ADMIN -->
  <div id="admin" class="card hidden">
    <h3>Admin ‚Äì Register Roles</h3>
    <input id="roleAddr" placeholder="0x address">
    <button onclick="send(() => contract.registerProducer(roleAddr.value))">Register Producer</button>
    <button onclick="send(() => contract.registerTransporter(roleAddr.value))">Register Transporter</button>
    <button onclick="send(() => contract.registerDistributor(roleAddr.value))">Register Distributor</button>
    <button onclick="send(() => contract.registerRetailer(roleAddr.value))">Register Retailer</button>
  </div>

  <!-- PRODUCER -->
  <div id="producer" class="card hidden">
    <h3>Producer ‚Äì Create Batch</h3>
    <input id="bid" placeholder="Batch ID">
    <input id="pname" placeholder="Product Name">
    <input id="qty" placeholder="Quantity">
    <button onclick="send(() => contract.createBatch(bid.value, pname.value, qty.value))">
      Create Batch
    </button>
  </div>

  <!-- TRANSPORTER -->
  <div id="transporter" class="card hidden">
    <h3>Transporter ‚Äì Add Sensor Data</h3>
    <input id="sid" placeholder="Batch ID">
    <input id="temp" placeholder="Temperature">
    <input id="hum" placeholder="Humidity">
    <input id="loc" placeholder="Location">
    <button onclick="send(() => contract.addSensorData(sid.value, temp.value, hum.value, loc.value))">
      Add Sensor Data
    </button>
  </div>

  <!-- DISTRIBUTOR -->
  <div id="distributor" class="card hidden">
    <h3>Distributor ‚Äì Transfer Ownership</h3>
    <input id="tid" placeholder="Batch ID">
    <input id="newOwner" placeholder="New Owner Address">
    <button onclick="send(() => contract.transferOwnership(tid.value, newOwner.value))">
      Transfer Ownership
    </button>
  </div>

  <!-- RETAILER -->
  <div id="retailer" class="card hidden">
    <h3>Retailer ‚Äì Inspection</h3>
    <input id="rid" placeholder="Batch ID">
    <button onclick="send(() => contract.markAsArrived(rid.value, true))">
      Mark Passed
    </button>
  </div>

  <!-- CUSTOMER -->
  <div id="customer" class="card hidden">
    <h3>Customer ‚Äì QR Code</h3>
    <input id="qrid" placeholder="Batch ID">
    <button onclick="generateQR()">Generate QR</button>
    <br><br>
    <img id="qrimg">
    <p id="qrlink"></p>
  </div>
</div>

<script>
const CONTRACT_ADDRESS = "0xC7d8B75156Ac7fd509aD5eC360Bd0258A4459bfd";

const ABI = [
 "function registerProducer(address)",
 "function registerTransporter(address)",
 "function registerDistributor(address)",
 "function registerRetailer(address)",
 "function createBatch(uint256,string,uint256)",
 "function addSensorData(uint256,int256,int256,string)",
 "function transferOwnership(uint256,address)",
 "function markAsArrived(uint256,bool)",
 "function isProducer(address) view returns (bool)",
 "function isTransporter(address) view returns (bool)",
 "function isDistributor(address) view returns (bool)",
 "function isRetailer(address) view returns (bool)",
 "function owner() view returns (address)"
];

let signer, contract, user;

function openPanel(id) {
  document.querySelectorAll(".card").forEach(c => c.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

async function connect() {
  const provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  user = await signer.getAddress();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  account.innerText = user;
  detectRole();
}

async function detectRole() {
  let roles = [];
  if (await contract.owner() === user) roles.push("Admin");
  if (await contract.isProducer(user)) roles.push("Producer");
  if (await contract.isTransporter(user)) roles.push("Transporter");
  if (await contract.isDistributor(user)) roles.push("Distributor");
  if (await contract.isRetailer(user)) roles.push("Retailer");
  role.innerText = "Role: " + (roles.length ? roles.join(" / ") : "-");
}

async function send(fn) {
  try {
    show("‚è≥ Waiting for MetaMask‚Ä¶", "ok");
    const tx = await fn();
    show("‚õì Transaction sent‚Ä¶", "ok");
    await tx.wait();
    show("‚úÖ Transaction confirmed!", "ok");
  } catch (e) {
    show("‚ùå " + (e.reason || e.message), "err");
  }
}

function show(msg, type) {
  status.innerHTML = `<div class="status ${type}">${msg}</div>`;
}

function generateQR() {
  const url = location.origin + location.pathname.replace("index.html","") +
    "scan.html?batchId=" + qrid.value;
  qrimg.src = "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" +
    encodeURIComponent(url);
  qrlink.innerText = url;
}

openPanel("producer");
</script>
</body>
</html>
