<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FreshChain ‚Äì Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  display: flex;
  height: 100vh;
}

/* SIDEBAR */
.sidebar {
  width: 300px;
  background: #111;
  color: #fff;
  padding: 20px;
}
.sidebar h2 { margin-top: 0; }
.sidebar button {
  width: 100%;
  margin: 6px 0;
  padding: 12px;
  background: #222;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
.sidebar button:hover { background: #444; }

#account {
  font-size: 13px;
  word-break: break-all;
  color: #ccc;
}
#role {
  margin-top: 6px;
  color: #9ae6b4;
}

/* MAIN */
.main {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

/* CARDS */
.card {
  max-width: 520px;
  border: 1px solid #ccc;
  padding: 16px;
  border-radius: 12px;
  margin-bottom: 20px;
}
input, button {
  width: 100%;
  padding: 12px;
  margin-top: 6px;
}
label {
  font-size: 14px;
  margin-top: 10px;
  display: block;
}
.hidden { display: none; }

/* STATUS */
.status {
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 12px;
}
.ok { background: #e6fffa; color: #065f46; }
.err { background: #fee2e2; color: #7f1d1d; }
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <h2>FreshChain</h2>

  <button onclick="connect()">üîå Connect Wallet</button>
  <button onclick="disconnect()">üîì Disconnect Wallet</button>

  <div id="account">Not connected</div>
  <div id="role">Role: -</div>

  <hr>

  <!-- SIDEBAR BUTTONS (ROLE-BASED) -->
  <button id="btnAdmin" onclick="openPanel('admin')" class="hidden">Admin</button>
  <button id="btnProducer" onclick="openPanel('producer')" class="hidden">Producer</button>
  <button id="btnTransporter" onclick="openPanel('transporter')" class="hidden">Transporter</button>
  <button id="btnDistributor" onclick="openPanel('distributor')" class="hidden">Distributor</button>
  <button id="btnRetailer" onclick="openPanel('retailer')" class="hidden">Retailer</button>
  <button id="btnCustomer" onclick="openPanel('customer')">Customer</button>
</div>

<!-- MAIN -->
<div class="main">
  <div id="status"></div>

  <!-- ADMIN -->
  <div id="admin" class="card hidden">
    <h3>Admin ‚Äì Register Roles</h3>

    <label>Producer Address</label>
    <input id="producerAddr" placeholder="0x Producer address">
    <button onclick="send(() => contract.registerProducer(producerAddr.value))">
      Register Producer
    </button>

    <label>Transporter Address</label>
    <input id="transporterAddr" placeholder="0x Transporter address">
    <button onclick="send(() => contract.registerTransporter(transporterAddr.value))">
      Register Transporter
    </button>

    <label>Distributor Address</label>
    <input id="distributorAddr" placeholder="0x Distributor address">
    <button onclick="send(() => contract.registerDistributor(distributorAddr.value))">
      Register Distributor
    </button>

    <label>Retailer Address</label>
    <input id="retailerAddr" placeholder="0x Retailer address">
    <button onclick="send(() => contract.registerRetailer(retailerAddr.value))">
      Register Retailer
    </button>
  </div>

  <!-- PRODUCER -->
  <div id="producer" class="card hidden">
    <h3>Producer ‚Äì Create Batch</h3>
    <input id="bid" placeholder="Batch ID">
    <input id="pname" placeholder="Product Name">
    <input id="qty" placeholder="Quantity">
    <button onclick="send(() => contract.createBatch(bid.value, pname.value, qty.value))">
      Create Batch
    </button>
  </div>

  <!-- TRANSPORTER -->
  <div id="transporter" class="card hidden">
    <h3>Transporter ‚Äì Add Sensor Data</h3>
    <input id="sid" placeholder="Batch ID">
    <input id="temp" placeholder="Temperature">
    <input id="hum" placeholder="Humidity">
    <input id="loc" placeholder="Location">
    <button onclick="send(() => contract.addSensorData(sid.value, temp.value, hum.value, loc.value))">
      Add Sensor Data
    </button>
  </div>

  <!-- DISTRIBUTOR -->
  <div id="distributor" class="card hidden">
    <h3>Distributor ‚Äì Transfer Ownership</h3>
    <input id="tid" placeholder="Batch ID">
    <input id="newOwner" placeholder="New Owner Address">
    <button onclick="send(() => contract.transferOwnership(tid.value, newOwner.value))">
      Transfer Ownership
    </button>
  </div>

  <!-- RETAILER -->
  <div id="retailer" class="card hidden">
    <h3>Retailer ‚Äì Inspection</h3>
    <input id="rid" placeholder="Batch ID">
    <button onclick="send(() => contract.markAsArrived(rid.value, true))">
      Mark Passed
    </button>
  </div>

  <!-- CUSTOMER -->
  <div id="customer" class="card hidden">
    <h3>Customer ‚Äì QR Code</h3>
    <input id="qrid" placeholder="Batch ID">
    <button onclick="generateQR()">Generate QR</button>
    <br><br>
    <img id="qrimg">
    <p id="qrlink"></p>
  </div>

</div>

<script>
const CONTRACT_ADDRESS = "0xC7d8B75156Ac7fd509aD5eC360Bd0258A4459bfd";

const ABI = [
 "function registerProducer(address)",
 "function registerTransporter(address)",
 "function registerDistributor(address)",
 "function registerRetailer(address)",
 "function createBatch(uint256,string,uint256)",
 "function addSensorData(uint256,int256,int256,string)",
 "function transferOwnership(uint256,address)",
 "function markAsArrived(uint256,bool)",
 "function isProducer(address) view returns (bool)",
 "function isTransporter(address) view returns (bool)",
 "function isDistributor(address) view returns (bool)",
 "function isRetailer(address) view returns (bool)",
 "function owner() view returns (address)"
];

let signer = null;
let contract = null;
let user = null;

function openPanel(id) {
  document.querySelectorAll(".card").forEach(c => c.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

async function connect() {
  const provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  user = await signer.getAddress();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  account.innerText = user;
  await applyRoleUI();
  show("‚úÖ Wallet connected", "ok");
}

function disconnect() {
  signer = null;
  contract = null;
  user = null;
  account.innerText = "Not connected";
  role.innerText = "Role: -";
  document.querySelectorAll(".card").forEach(c => c.classList.add("hidden"));
  document.querySelectorAll(".sidebar button").forEach(b => b.classList.add("hidden"));
  btnCustomer.classList.remove("hidden");
  show("üîì Wallet disconnected", "ok");
}

async function applyRoleUI() {
  // Hide all buttons first
  btnAdmin.classList.add("hidden");
  btnProducer.classList.add("hidden");
  btnTransporter.classList.add("hidden");
  btnDistributor.classList.add("hidden");
  btnRetailer.classList.add("hidden");

  let roles = [];

  if (await contract.owner() === user) {
    roles.push("Admin");
    btnAdmin.classList.remove("hidden");
    btnProducer.classList.remove("hidden");
    btnTransporter.classList.remove("hidden");
    btnDistributor.classList.remove("hidden");
    btnRetailer.classList.remove("hidden");
  }
  if (await contract.isProducer(user)) {
    roles.push("Producer");
    btnProducer.classList.remove("hidden");
  }
  if (await contract.isTransporter(user)) {
    roles.push("Transporter");
    btnTransporter.classList.remove("hidden");
  }
  if (await contract.isDistributor(user)) {
    roles.push("Distributor");
    btnDistributor.classList.remove("hidden");
  }
  if (await contract.isRetailer(user)) {
    roles.push("Retailer");
    btnRetailer.classList.remove("hidden");
  }

  role.innerText = "Role: " + (roles.length ? roles.join(" / ") : "-");

  // Open the first available role panel
  if (roles.includes("Admin")) openPanel("admin");
  else if (roles.includes("Producer")) openPanel("producer");
  else if (roles.includes("Transporter")) openPanel("transporter");
  else if (roles.includes("Distributor")) openPanel("distributor");
  else if (roles.includes("Retailer")) openPanel("retailer");
  else openPanel("customer");
}

async function send(fn) {
  if (!contract) {
    show("‚ùå Connect wallet first", "err");
    return;
  }
  try {
    show("‚è≥ Waiting for MetaMask‚Ä¶", "ok");
    const tx = await fn();
    show("‚õì Transaction sent‚Ä¶", "ok");
    await tx.wait();
    show("‚úÖ Transaction confirmed!", "ok");
  } catch (e) {
    show("‚ùå " + (e.reason || e.message), "err");
  }
}

function show(msg, type) {
  status.innerHTML = `<div class="status ${type}">${msg}</div>`;
}

function generateQR() {
  const url =
    location.origin +
    location.pathname.replace("index.html","") +
    "scan.html?batchId=" + qrid.value;

  qrimg.src =
    "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" +
    encodeURIComponent(url);

  qrlink.innerText = url;
}
</script>

</body>
</html>
