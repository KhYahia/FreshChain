<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FreshChain ‚Äì Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,sans-serif;display:flex;height:100vh}
.sidebar{width:320px;background:#111;color:#fff;padding:20px}
.sidebar button{width:100%;margin:6px 0;padding:14px;background:#222;color:#fff;border:none;border-radius:10px;cursor:pointer}
#account{word-break:break-all;font-size:13px;color:#ccc}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#222;font-size:12px;margin-top:8px}
.main{flex:1;padding:20px;overflow-y:auto}
.card{border:1px solid #ccc;padding:16px;border-radius:14px;max-width:700px;margin-bottom:20px}
input,button{padding:14px;margin:6px 0;width:100%;font-size:16px}
.hidden{display:none}
.status{padding:12px;border-radius:10px;margin-bottom:16px;font-size:14px}
.status.info{background:#eef}
.status.success{background:#e6ffed;color:#056608}
.status.error{background:#ffe6e6;color:#8a0000}
.small{font-size:12px;color:#666}
hr{border:none;border-top:1px solid #333;margin:12px 0}
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <h2>FreshChain</h2>
  <button onclick="connect()">üîå Connect Wallet</button>
  <p id="account">Not connected</p>
  <div id="roleBadge" class="badge">Role: -</div>
  <hr>
  <button onclick="openPanel('admin')">Admin</button>
  <button onclick="openPanel('producer')">Producer</button>
  <button onclick="openPanel('transporter')">Transporter</button>
  <button onclick="openPanel('distributor')">Distributor</button>
  <button onclick="openPanel('retailer')">Retailer</button>
  <button onclick="openPanel('customer')">Customer</button>
</div>

<!-- MAIN -->
<div class="main">

<div id="status" class="status info">‚ÑπÔ∏è Ready</div>

<!-- LIST BATCHES -->
<div class="card">
  <h3>üì¶ Available Batches</h3>
  <button onclick="loadBatches()">List Batches</button>
  <div id="batchList" class="small">No data yet.</div>
</div>

<!-- ADMIN -->
<div id="admin" class="card hidden">
  <h3>Admin ‚Äì Register Roles</h3>
  <input id="producerAddr" placeholder="Producer address">
  <button onclick="registerProducer()">Register Producer</button>
  <input id="transporterAddr" placeholder="Transporter address">
  <button onclick="registerTransporter()">Register Transporter</button>
  <input id="distributorAddr" placeholder="Distributor address">
  <button onclick="registerDistributor()">Register Distributor</button>
  <input id="retailerAddr" placeholder="Retailer address">
  <button onclick="registerRetailer()">Register Retailer</button>
</div>

<!-- PRODUCER -->
<div id="producer" class="card hidden">
  <h3>Producer ‚Äì Create Batch</h3>
  <input id="bid" placeholder="Batch ID">
  <input id="pname" placeholder="Product name">
  <input id="qty" placeholder="Quantity">
  <button onclick="createBatch()">Create Batch</button>
</div>

<!-- TRANSPORTER -->
<div id="transporter" class="card hidden">
  <h3>Transporter ‚Äì Add Sensor Data</h3>
  <input id="sid" placeholder="Batch ID">
  <input id="temp" placeholder="Temperature">
  <input id="hum" placeholder="Humidity">
  <input id="loc" placeholder="Location">
  <button onclick="addSensor()">Add Sensor Data</button>
</div>

<!-- DISTRIBUTOR -->
<div id="distributor" class="card hidden">
  <h3>Distributor ‚Äì Transfer Ownership</h3>
  <input id="tid" placeholder="Batch ID">
  <input id="newOwner" placeholder="New owner address">
  <button onclick="transferOwner()">Transfer Ownership</button>
</div>

<!-- RETAILER -->
<div id="retailer" class="card hidden">
  <h3>Retailer ‚Äì Inspection</h3>
  <input id="rid" placeholder="Batch ID">
  <button onclick="markArrived(true)">Mark Passed</button>
  <button onclick="markArrived(false)">Mark Failed</button>
</div>

<!-- CUSTOMER (QR ONLY) -->
<div id="customer" class="card hidden">
  <h3>Customer ‚Äì Verify Product</h3>
  <input id="trackId" placeholder="TrackID (Batch ID)">
  <button onclick="generateQR()">Generate QR</button>

  <div id="customerBlock" class="hidden">
    <img id="qrimg">
    <p id="qrlink" class="small"></p>
  </div>
</div>

</div>

<script>
/* CONFIG */
const CONTRACT_ADDRESS = "0xC7d8B75156Ac7fd509aD5eC360Bd0258A4459bfd";
const RPC = "https://eth-sepolia.g.alchemy.com/v2/7nq9DSo1P4TvLc7p9bOfr";

/* ABI */
const ABI = [
  "function owner() view returns (address)",
  "function isProducer(address) view returns (bool)",
  "function isTransporter(address) view returns (bool)",
  "function isDistributor(address) view returns (bool)",
  "function isRetailer(address) view returns (bool)",
  "function registerProducer(address)",
  "function registerTransporter(address)",
  "function registerDistributor(address)",
  "function registerRetailer(address)",
  "function createBatch(uint256,string,uint256)",
  "function addSensorData(uint256,int256,int256,string)",
  "function transferOwnership(uint256,address)",
  "function markAsArrived(uint256,bool)",
  "function listBatches() view returns (uint256[])"
];

let signer, contract;

function setStatus(msg,type="info"){
  statusBox.className="status "+type;
  statusBox.innerText=msg;
}

function openPanel(id){
  document.querySelectorAll(".card").forEach(c=>{
    if(c.id)c.classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
}

async function connect(){
  const provider=new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts",[]);
  signer=provider.getSigner();
  contract=new ethers.Contract(CONTRACT_ADDRESS,ABI,signer);
  const addr=await signer.getAddress();
  account.innerText=addr;
  setStatus("üü¢ Wallet connected","success");
  detectRole(addr);
}

async function detectRole(addr){
  const roles=[];
  if((await contract.owner()).toLowerCase()===addr.toLowerCase())roles.push("Admin");
  if(await contract.isProducer(addr))roles.push("Producer");
  if(await contract.isTransporter(addr))roles.push("Transporter");
  if(await contract.isDistributor(addr))roles.push("Distributor");
  if(await contract.isRetailer(addr))roles.push("Retailer");
  roleBadge.innerText="Role: "+(roles.length?roles.join(" / "):"Unregistered");
}

async function txWrap(promise,msg){
  try{
    setStatus("‚è≥ Transaction pending...");
    const tx=await promise;
    await tx.wait();
    setStatus("üü¢ "+msg,"success");
    loadBatches();
  }catch(e){
    setStatus("üî¥ "+(e.reason||e.message),"error");
  }
}

async function registerProducer(){txWrap(contract.registerProducer(producerAddr.value),"Producer registered")}
async function registerTransporter(){txWrap(contract.registerTransporter(transporterAddr.value),"Transporter registered")}
async function registerDistributor(){txWrap(contract.registerDistributor(distributorAddr.value),"Distributor registered")}
async function registerRetailer(){txWrap(contract.registerRetailer(retailerAddr.value),"Retailer registered")}

async function createBatch(){txWrap(contract.createBatch(bid.value,pname.value,qty.value),"Batch created")}
async function addSensor(){txWrap(contract.addSensorData(sid.value,temp.value,hum.value,loc.value),"Sensor added")}
async function transferOwner(){txWrap(contract.transferOwnership(tid.value,newOwner.value),"Ownership transferred")}
async function markArrived(p){txWrap(contract.markAsArrived(rid.value,p),"Inspection saved")}

async function loadBatches(){
  if(!contract)return;
  const ids=await contract.listBatches();
  batchList.innerHTML=ids.length?"Batch IDs: <b>"+ids.join(", ")+"</b>":"No batches";
}

/* QR ONLY */
function generateQR(){
  const id=trackId.value;
  if(!id){setStatus("‚ùå Enter TrackID","error");return;}

  const base=location.origin+location.pathname.replace("index.html","");
  const url=base+"scan.html?batchId="+id;

  qrimg.src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data="+encodeURIComponent(url);
  qrlink.innerText=url;
  customerBlock.classList.remove("hidden");
  setStatus("üü¢ QR code generated","success");
}

openPanel("customer");
</script>

</body>
</html>
