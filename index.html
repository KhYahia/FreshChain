<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>FreshChain ‚Äì Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
* { box-sizing: border-box; }
body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; }

.sidebar {
  width: 320px;
  background: #111;
  color: #fff;
  padding: 20px;
}

.sidebar button {
  width: 100%;
  padding: 14px;
  margin: 6px 0;
  border: none;
  border-radius: 10px;
  background: #222;
  color: #fff;
  cursor: pointer;
}
.sidebar button:hover { background: #444; }

#account {
  font-size: 13px;
  word-break: break-all;
  margin-top: 10px;
}

.main {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

.card {
  max-width: 600px;
  border: 1px solid #ccc;
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 20px;
}

input, button {
  width: 100%;
  padding: 14px;
  margin: 6px 0;
  font-size: 16px;
}

.hidden { display: none; }

#msg {
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 16px;
}
#msg.ok { background: #e7f7ec; color: #136c2e; }
#msg.err { background: #fde8e8; color: #8a1f1f; }
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <h2>FreshChain</h2>

  <button onclick="connect()">üîå Connect Wallet</button>
  <button onclick="disconnect()">‚ùå Disconnect Wallet</button>

  <p id="account">Not connected</p>
  <p id="role">Role: -</p>
  <hr>

  <button id="btnAdmin" onclick="openPanel('admin')">Admin</button>
  <button id="btnProducer" onclick="openPanel('producer')">Producer</button>
  <button id="btnTransporter" onclick="openPanel('transporter')">Transporter</button>
  <button id="btnDistributor" onclick="openPanel('distributor')">Distributor</button>
  <button id="btnRetailer" onclick="openPanel('retailer')">Retailer</button>
  <button onclick="openPanel('customer')">Customer</button>
</div>

<!-- MAIN -->
<div class="main">

<div id="msg" class="hidden"></div>

<!-- ADMIN -->
<div id="admin" class="card hidden">
  <h3>Admin ‚Äì Register Roles</h3>

  <input id="producerAddr" placeholder="Producer address" />
  <button onclick="send(()=>registerRole('producer'))">Register Producer</button>

  <input id="transporterAddr" placeholder="Transporter address" />
  <button onclick="send(()=>registerRole('transporter'))">Register Transporter</button>

  <input id="distributorAddr" placeholder="Distributor address" />
  <button onclick="send(()=>registerRole('distributor'))">Register Distributor</button>

  <input id="retailerAddr" placeholder="Retailer address" />
  <button onclick="send(()=>registerRole('retailer'))">Register Retailer</button>
</div>

<!-- PRODUCER -->
<div id="producer" class="card hidden">
  <h3>Producer ‚Äì Create Batch</h3>
  <input id="bid" placeholder="Batch ID" />
  <input id="pname" placeholder="Product name" />
  <input id="qty" placeholder="Quantity" />
  <button onclick="send(createBatch)">Create Batch</button>
</div>

<!-- TRANSPORTER -->
<div id="transporter" class="card hidden">
  <h3>Transporter ‚Äì Add Sensor Data</h3>
  <input id="sid" placeholder="Batch ID" />
  <input id="temp" placeholder="Temperature (¬∞C)" />
  <input id="hum" placeholder="Humidity (%)" />
  <input id="loc" placeholder="Location" />
  <button onclick="send(addSensor)">Add Sensor Data</button>
</div>

<!-- DISTRIBUTOR -->
<div id="distributor" class="card hidden">
  <h3>Distributor ‚Äì Transfer Ownership</h3>
  <input id="tid" placeholder="Batch ID" />
  <input id="newOwner" placeholder="New owner address" />
  <button onclick="send(transferOwner)">Transfer Ownership</button>
</div>

<!-- RETAILER -->
<div id="retailer" class="card hidden">
  <h3>Retailer ‚Äì Inspection</h3>
  <input id="rid" placeholder="Batch ID" />
  <button onclick="send(()=>markArrived(true))">Mark Passed</button>
  <button onclick="send(()=>markArrived(false))">Mark Failed</button>
</div>

<!-- CUSTOMER -->
<div id="customer" class="card hidden">
  <h3>Customer ‚Äì QR Code</h3>
  <input id="qrid" placeholder="Batch ID" />
  <button onclick="generateQR()">Generate QR</button>
  <img id="qrimg" />
  <p id="qrlink"></p>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const CONTRACT_ADDRESS = "0xC7d8B75156Ac7fd509aD5eC360Bd0258A4459bfd";
const RPC = "https://eth-sepolia.g.alchemy.com/v2/7nq9DSo1P4TvLc7p9bOfr";

const ABI = [
 "function registerProducer(address)",
 "function registerTransporter(address)",
 "function registerDistributor(address)",
 "function registerRetailer(address)",
 "function createBatch(uint256,string,uint256)",
 "function addSensorData(uint256,int256,int256,string)",
 "function transferOwnership(uint256,address)",
 "function markAsArrived(uint256,bool)",
 "function isProducer(address) view returns(bool)",
 "function isTransporter(address) view returns(bool)",
 "function isDistributor(address) view returns(bool)",
 "function isRetailer(address) view returns(bool)",
 "function owner() view returns(address)"
];

let provider, signer, contract, currentAccount;

/* ================= UI HELPERS ================= */
function show(msg, type) {
  const el = document.getElementById("msg");
  el.className = type ? type : "";
  el.innerText = msg;
  el.classList.remove("hidden");
}
function clearMsg() {
  document.getElementById("msg").classList.add("hidden");
}

function openPanel(id) {
  document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  clearMsg();
}

/* ================= VALIDATION ================= */
function requireValue(v, m){ if(!v||v.toString().trim()==="") throw new Error(m); }
function requireNumber(v,m){ requireValue(v,m); if(isNaN(v)) throw new Error(m+" must be a number."); }
function requirePositive(v,m){ requireNumber(v,m); if(v<=0) throw new Error(m+" must be > 0."); }
function requireAddress(a,m){ requireValue(a,m); if(!ethers.utils.isAddress(a)) throw new Error("Invalid "+m+"."); }
function requireTemp(t){ requireNumber(t,"Temperature"); if(t<-50||t>100) throw new Error("Temperature must be between -50¬∞C and 100¬∞C."); }
function requireHum(h){ requireNumber(h,"Humidity"); if(h<0||h>100) throw new Error("Humidity must be between 0% and 100%."); }

/* ================= WALLET ================= */
async function connect(){
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts",[]);
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  currentAccount = await signer.getAddress();
  document.getElementById("account").innerText = currentAccount;
  await applyRoles();
}

function disconnect(){
  provider = signer = contract = currentAccount = null;
  document.getElementById("account").innerText = "Not connected";
  document.getElementById("role").innerText = "Role: -";
  document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"));
  clearMsg();
}

/* ================= ROLES ================= */
async function applyRoles(){
  const owner = await contract.owner();
  let roles = [];

  if(currentAccount.toLowerCase()===owner.toLowerCase()){
    roles.push("Admin");
    ["btnAdmin","btnProducer","btnTransporter","btnDistributor","btnRetailer"].forEach(id=>document.getElementById(id).style.display="block");
    openPanel("admin");
  } else {
    if(await contract.isProducer(currentAccount)){ roles.push("Producer"); openPanel("producer"); }
    if(await contract.isTransporter(currentAccount)){ roles.push("Transporter"); openPanel("transporter"); }
    if(await contract.isDistributor(currentAccount)){ roles.push("Distributor"); openPanel("distributor"); }
    if(await contract.isRetailer(currentAccount)){ roles.push("Retailer"); openPanel("retailer"); }

    ["btnAdmin","btnProducer","btnTransporter","btnDistributor","btnRetailer"].forEach(id=>document.getElementById(id).style.display="none");
  }

  document.getElementById("role").innerText = "Role: " + (roles.join(", ") || "Customer");
}

/* ================= ACTIONS ================= */
async function send(action){
  try{
    clearMsg();
    const tx = await action();
    show("‚è≥ Transaction sent. Waiting confirmation‚Ä¶","ok");
    await tx.wait();
    show("‚úÖ Transaction successful.","ok");
    await applyRoles();
  }catch(e){
    show(e.message || "Transaction failed.","err");
  }
}

function registerRole(type){
  if(type==="producer"){ requireAddress(producerAddr.value,"Producer address"); return contract.registerProducer(producerAddr.value); }
  if(type==="transporter"){ requireAddress(transporterAddr.value,"Transporter address"); return contract.registerTransporter(transporterAddr.value); }
  if(type==="distributor"){ requireAddress(distributorAddr.value,"Distributor address"); return contract.registerDistributor(distributorAddr.value); }
  if(type==="retailer"){ requireAddress(retailerAddr.value,"Retailer address"); return contract.registerRetailer(retailerAddr.value); }
}

function createBatch(){
  requireNumber(bid.value,"Batch ID");
  requireValue(pname.value,"Product name");
  requirePositive(qty.value,"Quantity");
  return contract.createBatch(bid.value,pname.value,qty.value);
}

function addSensor(){
  requireNumber(sid.value,"Batch ID");
  requireTemp(temp.value);
  requireHum(hum.value);
  requireValue(loc.value,"Location");
  return contract.addSensorData(sid.value,temp.value,hum.value,loc.value);
}

function transferOwner(){
  requireNumber(tid.value,"Batch ID");
  requireAddress(newOwner.value,"New owner address");
  return contract.transferOwnership(tid.value,newOwner.value);
}

function markArrived(p){
  requireNumber(rid.value,"Batch ID");
  return contract.markAsArrived(rid.value,p);
}

function generateQR(){
  requireNumber(qrid.value,"Batch ID");
  const url = location.origin + location.pathname.replace("index.html","") + "scan.html?batchId="+qrid.value;
  qrimg.src = "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data="+encodeURIComponent(url);
  qrlink.innerText = url;
}
</script>

</body>
</html>
