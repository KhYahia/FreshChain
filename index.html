<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FreshChain ‚Äì Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: Arial, sans-serif;
  display: flex;
  height: 100vh;
}

/* SIDEBAR */
.sidebar {
  width: 320px;
  background: #111;
  color: #fff;
  padding: 20px;
}

.sidebar button {
  width: 100%;
  margin: 6px 0;
  padding: 14px;
  background: #222;
  color: #fff;
  border: none;
  border-radius: 10px;
  cursor: pointer;
}

#account {
  word-break: break-all;
  font-size: 13px;
  color: #ccc;
}

/* MAIN */
.main {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

.card {
  border: 1px solid #ccc;
  padding: 16px;
  border-radius: 14px;
  max-width: 520px;
  margin-bottom: 20px;
}

input, button {
  padding: 14px;
  margin: 6px 0;
  width: 100%;
}

.hidden { display: none; }

/* STATUS */
.status {
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 16px;
  font-size: 14px;
}
.status.info { background: #eef; }
.status.success { background: #e6ffed; color: #056608; }
.status.error { background: #ffe6e6; color: #8a0000; }
</style>
</head>

<body>

<div class="sidebar">
  <h2>FreshChain</h2>
  <button onclick="connect()">üîå Connect Wallet</button>
  <p id="account">Not connected</p>
  <hr>
  <button onclick="openPanel('admin')">Admin</button>
  <button onclick="openPanel('producer')">Producer</button>
  <button onclick="openPanel('transporter')">Transporter</button>
  <button onclick="openPanel('distributor')">Distributor</button>
  <button onclick="openPanel('retailer')">Retailer</button>
  <button onclick="openPanel('customer')">Customer</button>
</div>

<div class="main">

<div id="status" class="status info">‚ÑπÔ∏è Ready</div>

<!-- ADMIN -->
<div id="admin" class="card hidden">
  <h3>Admin ‚Äì Register Roles</h3>

  <input id="producerAddr" placeholder="Producer address">
  <button onclick="registerProducer()">Register Producer</button>

  <input id="transporterAddr" placeholder="Transporter address">
  <button onclick="registerTransporter()">Register Transporter</button>

  <input id="distributorAddr" placeholder="Distributor address">
  <button onclick="registerDistributor()">Register Distributor</button>

  <input id="retailerAddr" placeholder="Retailer address">
  <button onclick="registerRetailer()">Register Retailer</button>
</div>

<!-- PRODUCER -->
<div id="producer" class="card hidden">
  <h3>Producer ‚Äì Create Batch</h3>
  <input id="bid" placeholder="Batch ID">
  <input id="pname" placeholder="Product name">
  <input id="qty" placeholder="Quantity">
  <button onclick="createBatch()">Create Batch</button>
</div>

<!-- TRANSPORTER -->
<div id="transporter" class="card hidden">
  <h3>Transporter ‚Äì Sensor Data</h3>
  <input id="sid" placeholder="Batch ID">
  <input id="temp" placeholder="Temperature">
  <input id="hum" placeholder="Humidity">
  <input id="loc" placeholder="Location">
  <button onclick="addSensor()">Add Sensor Data</button>
</div>

<!-- DISTRIBUTOR -->
<div id="distributor" class="card hidden">
  <h3>Distributor ‚Äì Transfer Ownership</h3>
  <input id="tid" placeholder="Batch ID">
  <input id="newOwner" placeholder="New owner address">
  <button onclick="transferOwner()">Transfer Ownership</button>
</div>

<!-- RETAILER -->
<div id="retailer" class="card hidden">
  <h3>Retailer ‚Äì Inspection</h3>
  <input id="rid" placeholder="Batch ID">
  <button onclick="markArrived(true)">Mark Passed</button>
  <button onclick="markArrived(false)">Mark Failed</button>
</div>

<!-- CUSTOMER -->
<div id="customer" class="card hidden">
  <h3>Customer ‚Äì QR Code</h3>
  <input id="qrid" placeholder="Batch ID">
  <button onclick="generateQR()">Generate QR</button>
  <br><br>
  <img id="qrimg">
  <p id="qrlink"></p>
</div>

</div>

<script>
const CONTRACT_ADDRESS = "0x9167AD9a32c5148F461bc6EbE9831236337f2612";

const ABI = [
 "function registerProducer(address)",
 "function registerTransporter(address)",
 "function registerDistributor(address)",
 "function registerRetailer(address)",
 "function createBatch(uint256,string,uint256)",
 "function addSensorData(uint256,int256,int256,string)",
 "function transferOwnership(uint256,address)",
 "function markAsArrived(uint256,bool)"
];

let signer, contract;
const account = document.getElementById("account");
const statusBox = document.getElementById("status");

function setStatus(msg, type="info") {
  statusBox.className = "status " + type;
  statusBox.innerText = msg;
}

function openPanel(id) {
  document.querySelectorAll(".card").forEach(c => c.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

async function connect() {
  try {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
    account.innerText = await signer.getAddress();
    setStatus("üü¢ Wallet connected", "success");
  } catch {
    setStatus("üî¥ Wallet connection failed", "error");
  }
}

/* ADMIN */
async function registerProducer() {
  await txWrap(contract.registerProducer(producerAddr.value), "Producer registered");
}
async function registerTransporter() {
  await txWrap(contract.registerTransporter(transporterAddr.value), "Transporter registered");
}
async function registerDistributor() {
  await txWrap(contract.registerDistributor(distributorAddr.value), "Distributor registered");
}
async function registerRetailer() {
  await txWrap(contract.registerRetailer(retailerAddr.value), "Retailer registered");
}

/* ACTIONS */
async function createBatch() {
  await txWrap(contract.createBatch(bid.value, pname.value, qty.value), "Batch created");
}
async function addSensor() {
  await txWrap(contract.addSensorData(sid.value, temp.value, hum.value, loc.value), "Sensor data added");
}
async function transferOwner() {
  await txWrap(contract.transferOwnership(tid.value, newOwner.value), "Ownership transferred");
}
async function markArrived(passed) {
  await txWrap(contract.markAsArrived(rid.value, passed), "Inspection saved");
}

/* TRANSACTION HANDLER */
async function txWrap(txPromise, successMsg) {
  try {
    setStatus("‚è≥ Transaction pending...", "info");
    const tx = await txPromise;
    await tx.wait();
    setStatus("üü¢ " + successMsg, "success");
  } catch (e) {
    setStatus("üî¥ " + (e.reason || e.message), "error");
  }
}

/* QR GENERATION ‚Äî CORRECT FOR GITHUB PAGES */
function generateQR() {
  const base =
    location.origin +
    location.pathname.replace("index.html", "");

  const url = base + "scan.html?batchId=" + qrid.value;

  qrimg.src =
    "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" +
    encodeURIComponent(url);

  qrlink.innerText = url;
}

openPanel("admin");
</script>

</body>
</html>
