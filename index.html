<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FreshChain â€“ Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: Arial, sans-serif;
  display: flex;
  height: 100vh;
}

/* SIDEBAR */
.sidebar {
  width: 240px;
  background: #111;
  color: #fff;
  padding: 20px;
}

.sidebar h2 {
  font-size: 18px;
  margin-bottom: 10px;
}

.sidebar button {
  width: 100%;
  margin: 6px 0;
  padding: 12px;
  background: #222;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.sidebar button:hover {
  background: #444;
}

/* MAIN */
.main {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

/* TOP BAR (MOBILE) */
.topbar {
  display: none;
  background: #111;
  color: #fff;
  padding: 12px;
  align-items: center;
  justify-content: space-between;
}

.menu-btn {
  font-size: 22px;
  cursor: pointer;
}

.card {
  border: 1px solid #ccc;
  padding: 16px;
  border-radius: 12px;
  margin-bottom: 20px;
  max-width: 520px;
}

input, button {
  padding: 12px;
  margin: 6px 0;
  width: 100%;
  font-size: 16px;
}

.hidden {
  display: none;
}

/* MOBILE */
@media (max-width: 768px) {
  body {
    flex-direction: column;
  }

  .sidebar {
    position: fixed;
    height: 100%;
    z-index: 1000;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
  }

  .sidebar.show {
    transform: translateX(0);
  }

  .topbar {
    display: flex;
  }

  .main {
    padding: 16px;
  }
}
</style>
</head>

<body>

<!-- MOBILE TOP BAR -->
<div class="topbar">
  <span class="menu-btn" onclick="toggleMenu()">â˜°</span>
  <strong>FreshChain</strong>
  <span></span>
</div>

<!-- SIDEBAR -->
<div id="sidebar" class="sidebar">
  <h2>FreshChain</h2>

  <button onclick="connect()">ðŸ”Œ Connect Wallet</button>
  <p id="account" style="font-size:12px;">Not connected</p>

  <hr>

  <button onclick="openPanel('admin')">Admin</button>
  <button onclick="openPanel('producer')">Producer</button>
  <button onclick="openPanel('transporter')">Transporter</button>
  <button onclick="openPanel('distributor')">Distributor</button>
  <button onclick="openPanel('retailer')">Retailer</button>
  <button onclick="openPanel('customer')">Customer</button>
</div>

<!-- MAIN -->
<div class="main">

  <div id="admin" class="card hidden">
    <h3>Admin â€“ Register Roles</h3>
    <input id="roleAddr" placeholder="0x address">
    <button onclick="register('registerProducer')">Register Producer</button>
    <button onclick="register('registerTransporter')">Register Transporter</button>
    <button onclick="register('registerDistributor')">Register Distributor</button>
    <button onclick="register('registerRetailer')">Register Retailer</button>
  </div>

  <div id="producer" class="card hidden">
    <h3>Producer â€“ Create Batch</h3>
    <input id="bid" placeholder="Batch ID">
    <input id="pname" placeholder="Product name">
    <input id="qty" placeholder="Quantity">
    <button onclick="createBatch()">Create Batch</button>
  </div>

  <div id="transporter" class="card hidden">
    <h3>Transporter â€“ Sensor Data</h3>
    <input id="sid" placeholder="Batch ID">
    <input id="temp" placeholder="Temperature">
    <input id="hum" placeholder="Humidity">
    <input id="loc" placeholder="Location">
    <button onclick="addSensor()">Add Sensor Data</button>
  </div>

  <div id="distributor" class="card hidden">
    <h3>Distributor â€“ Transfer Ownership</h3>
    <input id="tid" placeholder="Batch ID">
    <input id="newOwner" placeholder="New owner address">
    <button onclick="transferOwner()">Transfer Ownership</button>
  </div>

  <div id="retailer" class="card hidden">
    <h3>Retailer â€“ Inspection</h3>
    <input id="rid" placeholder="Batch ID">
    <button onclick="markArrived(true)">Mark Passed</button>
    <button onclick="markArrived(false)">Mark Failed</button>
  </div>

  <div id="customer" class="card hidden">
    <h3>Customer â€“ QR Code</h3>
    <input id="qrid" placeholder="Batch ID">
    <button onclick="generateQR()">Generate QR</button>
    <br><br>
    <img id="qrimg">
    <p id="qrlink"></p>
  </div>

</div>

<script>
const CONTRACT_ADDRESS = "0x9167AD9a32c5148F461bc6EbE9831236337f2612";

const ABI = [
 "function registerProducer(address)",
 "function registerTransporter(address)",
 "function registerDistributor(address)",
 "function registerRetailer(address)",
 "function createBatch(uint256,string,uint256)",
 "function addSensorData(uint256,int256,int256,string)",
 "function transferOwnership(uint256,address)",
 "function markAsArrived(uint256,bool)"
];

let signer, contract;
const account = document.getElementById("account");

function toggleMenu() {
  document.getElementById("sidebar").classList.toggle("show");
}

function openPanel(id) {
  document.querySelectorAll(".card").forEach(c => c.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");

  // close menu on mobile
  document.getElementById("sidebar").classList.remove("show");
}

async function connect() {
  if (!window.ethereum) {
    alert("MetaMask not found");
    return;
  }
  const provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  account.innerText = await signer.getAddress();
}

async function register(fn) {
  const tx = await contract[fn](roleAddr.value);
  await tx.wait();
  alert("Role registered");
}

async function createBatch() {
  const tx = await contract.createBatch(bid.value, pname.value, qty.value);
  await tx.wait();
  alert("Batch created");
}

async function addSensor() {
  const tx = await contract.addSensorData(sid.value, temp.value, hum.value, loc.value);
  await tx.wait();
  alert("Sensor data added");
}

async function transferOwner() {
  const tx = await contract.transferOwnership(tid.value, newOwner.value);
  await tx.wait();
  alert("Ownership transferred");
}

async function markArrived(passed) {
  const tx = await contract.markAsArrived(rid.value, passed);
  await tx.wait();
  alert("Inspection saved");
}

function generateQR() {
  const url =
    location.origin +
    location.pathname.replace("index.html","") +
    "scan.html?batchId=" + qrid.value;

  qrimg.src =
    "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" +
    encodeURIComponent(url);

  qrlink.innerText = url;
}

/* DEFAULT VIEW */
openPanel('producer');
</script>

</body>
</html>
